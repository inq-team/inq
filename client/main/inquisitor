#!/bin/sh -e

. /etc/inquisitor/global
. $SHARE_DIR/functions
. $SHARE_DIR/communication
if [ -r $SHARE_DIR/init ] && ! [ -r /proc/cpuinfo ]; then
	. $SHARE_DIR/init
fi

# ===========================================================================
# Detects
# ===========================================================================

# Save detection logs
dmidecode > $HOME/dmi.log
decode-dimms.pl > $HOME/spd.log
ipmitool fru 2>/dev/null > $HOME/fru.log || true
lspci > $HOME/lspci.log
lshw 2>/dev/null > $HOME/lshw.log

echo 'Starting detects'
for I in $SHARE_DIR/detect/*; do
	echo -n "Detecting `basename $I`"
	. $I
	echo_success
done
echo 'Detects finished'

# ===========================================================================
# Self-identification
# ===========================================================================

echo 'Starting self-identification'
# Try various methods for self-id, stop after successful one
COMPUTER_ID=
for I in $SHARE_DIR/self-id/*; do
	echo -n "Trying self-id using $I"
	. $I
	if [ -n "$COMPUTER_ID" ]; then
		echo_success
		break
	else
		echo_failure
	fi
done
[ -n "$COMPUTER_ID" ] || fatal_failure 'Self-identification'

# Reporting IP-address to the server
publish_my_ip || fatal_failure 'IP-address update'

# ===========================================================================
# Start logging
# ===========================================================================

hostname c$COMPUTER_ID
/sbin/service syslog-ng start

# ===========================================================================
# Set time
# ===========================================================================

echo -n 'Trying set local time '
if [ -n "$NTP_SERVER" ]; then
	if /usr/sbin/ntpdate $NTP_SERVER $1>/dev/null && /sbin/hwclock --systohc; then
		echo_success
	else
		echo_failure
	fi
else
	echo -n '(ntp server does not set)'
	echo_skipped
fi

# ===========================================================================
# Start watchdog, if available
# ===========================================================================

watchdog_start

# ===========================================================================
# Submit configuration by REST
# ===========================================================================

submit_components $HOME/components.xml

# ===========================================================================
# Run all tests
# ===========================================================================

TEST_NAME=cpu PLANNER=1 \
	TEST_TIME=900 \
	run_test cpu

TEST_NAME=memory PLANNER=1 \
	TEST_LOOPS=1 \
	LOGTIME=120 \
	run_test memory

export COMPUTER_ID && export SHARE_DIR && \
TEST_NAME=hdd-passthrough PLANNER=1 \
	run_test hdd-passthrough

TEST_NAME=hdd-array PLANNER=1 \
	TESTTIME=3600 \
	LOGTIME=120 \
	JOBS=32 \
	STRESS_TREE=/usr/share/inquisitor/linux-2.6.22.5-31-stress.tar.gz \
	run_test hdd-array

TEST_NAME=net PLANNER=1 \
	MD5=ca658fd4159bc35698edf9a1cdd70876 \
	URL=3000/test_file.html \
	TIMEOUT=30 \
	run_test net

TEST_NAME=fdd PLANNER=1 \
	FLOPPY_SIZE=1440 \
	run_test fdd

TEST_NAME=odd_read PLANNER=1 \
	TEST_IMAGE_HASH=2e8744dfd11bf425001aad57976d42cc \
	TEST_IMAGE_BLOCKS=50000 \
	MESH_POINTS=1024 \
	FORCE_NON_INTERACTIVE=false \
	run_test odd_read

TEST_NAME=usb-flash-drive PLANNER=1 \
	BLOCKSIZE=1024 \
	SIZE=20 \
	COUNT=2 \
	run_test usb-flash-drive

# We completed all tests
print_green_message "================"
print_green_message "TESTING FINISHED"
print_green_message "================"

testing_finished

bash
