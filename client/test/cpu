#!/bin/sh -ef
# NAME=CPU burning
# DESCRIPTION=CPU burn-in testing
# DESTROYS_HDD=false
# IS_INTERACTIVE=false
# POWEROFF_DURING_TEST=false
# VERSION=0.1
# TAGS=cpu,stress
# VAR=TEST_TIME:int:1800:Total time of CPU testing
# VAR=LOG_TIME:int:120:Time between progress updates

. /usr/share/inquisitor/functions-test

detect_burn_program()
{
	CPU_VENDOR=`grep vendor_id /proc/cpuinfo | awk '{print $3}' | sed '2,$d'`

	case $CPU_VENDOR in
	AuthenticAMD)
		BURN_PROGRAM="burnK7"
		;;
	*)
		BURN_PROGRAM="burnP6"
		;;
	esac
}

detect_cpu_quantity()
{
	CPU_QUANTITY=`grep processor /proc/cpuinfo | wc -l`
}

start_burn()
{
	for i in `seq 1 $CPU_QUANTITY`; do
		$BURN_PROGRAM &
		echo $! >~/cpuburn$i.pid
	done
}

stop_burn()
{
	for i in `seq 1 $CPU_QUANTITY`; do
		killbypid cpuburn$i
	done
}

check_alive_burners()
{
	for i in `seq 1 $CPU_QUANTITY`; do
		$(( `ps \`cat ~/cpuburn$i.pid\` | wc -l` == 2 )) || test_failed
	done
}

affinite_burners()
{
	[ "$CPU_QUANTITY" -eq 1 ] && return

	cpu_affinity `cat ~cpuburn1.pid` 1
	for i in `seq 2 2 $CPU_QUANTITY`; do
		cpu_affinity `cat ~/cpuburn$i.pid` $i
	done
}

detect_burn_program
detect_cpu_quantity
start_burn
#affinite_burners #as it is cirrently untested
test_started $TEST_TIME

START=`date "+%s"`
while true; do
	sleep $LOG_TIME
	TIME=`date "+%s"`
	check_alive_burners
	if $(( $TIME - $START > $TEST_TIME )); then
		stop_burn
		test_succeeded
		break
	else
		test_progress $(( $TIME - $START )) $TEST_TIME
	fi
done
